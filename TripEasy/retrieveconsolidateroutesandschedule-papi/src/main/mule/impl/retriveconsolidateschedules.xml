<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<http:request-config name="HTTP_Request_configuration-travelontrip" doc:name="HTTP Request configuration" doc:id="2507ad59-c326-48a4-aab2-6436c5492308" >
		<http:request-connection host="${http.requester.travelOnTrip.host}" port="${http.requester.travelOnTrip.port}" />
	</http:request-config>
	<ee:object-store-caching-strategy name="Caching_Strategy1" doc:name="Caching Strategy" doc:id="969f7b42-207c-42d8-b220-76a67172b56d" keyGenerationExpression='#[vars.transportType ++ vars.companyname ++ "Schedule"]' />
	<sub-flow name="travelontrip-schedule-cache" doc:id="a50a203c-5595-4a3c-85ba-1424e4146c36" >
		<set-variable value="#[%dw 2.0&#10;output application/json&#10;---&#10;&quot;/api/&quot; ++ (vars.transportType default &quot;Bus&quot;) ++ p('http.requester.travelOnTrip.schedulesPath')]" doc:name="travelOnTrip-schedule" doc:id="0fbc77ef-284c-4e6e-9ae4-68ccc2c7d884" variableName="resuorsePath" />
		<ee:cache doc:name="Cache" doc:id="b8bf53eb-c5de-4275-93c2-5e00ed090a6e" cachingStrategy-ref="Caching_Strategy1">
					<http:request method="GET" doc:name="travelOnTrip-schedule-Request" doc:id="4e1eac47-ef47-41f0-a023-39de10128fbb" config-ref="HTTP_Request_configuration-travelontrip" path="#[vars.resuorsePath]">
					<http:headers><![CDATA[#[output application/java
---
{
	TransactionId : vars.transactionId
}]]]></http:headers>
					<http:uri-params><![CDATA[#[output application/java
---
{
	transportType : vars.transportType
}]]]></http:uri-params>
				</http:request>
					<ee:transform doc:name="Transform Message" doc:id="ebb7b2b0-6df2-451b-9c51-839962f36de9">
						<ee:message>
							<ee:set-payload><![CDATA[%dw 2.0 
output application/json 
var LocationMapping = readUrl("classpath://json/LocationCodeMapping.json","application/json") 
--- 
payload map (value, index) ->(
    {
        "companyCode" : vars.companyname, 
	"avilableSeats" : value.availabileseat, 
	"departureDateTime" : value.DepartureTime, 
        "originLocation" : {
            "locationCode" : value.travelRoute.originLocation.locationCode,
            "locationDesc" : (LocationMapping filter($.locationCode == value.travelRoute.originLocation.locationCode))[0].locationDesc 
        },
        "destinationLocation" :{
            "locationCode" : value.travelRoute.destinationLocation.locationCode,
            "locationDesc" : (LocationMapping filter($.locationCode == value.travelRoute.destinationLocation.locationCode))[0].locationDesc 
        } 

    }
 )]]></ee:set-payload>
						</ee:message>
					</ee:transform>
					<logger level="INFO" doc:name="Logger" doc:id="2b6a8956-6993-44e2-ab43-9677f5b7146e" message='#[vars.transportType ++ vars.companyname ++ "Schedule cache cmpt"]' />
				</ee:cache>
	</sub-flow>
	<sub-flow name="fastgo-schedule-cache" doc:id="43458a4e-a883-42da-a6b1-e623db69f0a9" >
		<set-variable value="#[%dw 2.0&#10;output application/json&#10;---&#10;&quot;/api/&quot; ++ (vars.transportType default &quot;Bus&quot;) ++ p('http.requester.fastgo.schedulesPath')]" doc:name="Fastgo-schedule" doc:id="5702a5e6-e8fa-4cbe-8a5c-3084f18b1623" variableName="resourcePath" />
		<ee:cache doc:name="Cache" doc:id="870a56f0-66e4-446f-8ade-c1014a768c6e" cachingStrategy-ref="Caching_Strategy1">
					<http:request method="GET" doc:name="Fastgo-schedule-Request" doc:id="e039c7bd-f4f4-4ce1-b0cb-35df36f1f7a3" config-ref="HTTP_Request_configuration-fastgo" path="#[vars.resourcePath]">
					<http:headers><![CDATA[#[output application/java
---
{
	TransactionId : vars.transactionId
}]]]></http:headers>
					<http:uri-params><![CDATA[#[output application/java
---
{
	transportType : vars.transportType
}]]]></http:uri-params>
				</http:request>
					<ee:transform doc:name="Transform Message" doc:id="9d4e529e-372a-4239-8d85-3babe882f26f">
						<ee:message>
							<ee:set-payload><![CDATA[%dw 2.0 
output application/json 
var LocationMapping = readUrl("classpath://json/LocationCodeMapping.json","application/json") 
--- 
payload map (value, index) ->(
    {
        "companyCode" : vars.companyname, 
	"avilableSeats" : value.availabileseat, 
	"departureDateTime" : value.DepartureTime, 
        "originLocation" : {
            "locationCode" : value.travelRoute.originLocation.locationCode,
            "locationDesc" : (LocationMapping filter($.locationCode == value.travelRoute.originLocation.locationCode))[0].locationDesc 
        },
        "destinationLocation" :{
            "locationCode" : value.travelRoute.destinationLocation.locationCode,
            "locationDesc" : (LocationMapping filter($.locationCode == value.travelRoute.destinationLocation.locationCode))[0].locationDesc 
        } 

    }
 )]]></ee:set-payload>
						</ee:message>
					</ee:transform>
					<logger level="INFO" doc:name="Logger" doc:id="f5d6479a-5b96-45f0-a351-09c53c74940c" message='#[vars.transportType ++ vars.companyname ++ "Schedule cmpt fastgo cache process"]' />
				</ee:cache>
	</sub-flow>
	<sub-flow name="retriveconsolidateschedules-Sub_Flow" doc:id="2e777b7e-a16c-4ea6-afb2-f63a4e89b5c3" >
		<choice doc:name="Choice" doc:id="d20fb41d-5afa-4c37-b361-69f9707d1534" >
			<when expression='#[vars.companyName == "FastGo"]'>
				<flow-ref doc:name="calling-fastgo-schedule-cache" doc:id="04c3d761-2b58-4055-8e9b-1bdd73a900ce" name="fastgo-schedule-cache" />
			</when>
			<when expression='#[vars.companyName == "travelOnTrip"]'>
				<flow-ref doc:name="calling-travelontrip-schedule-cache" doc:id="0565d24f-7760-4129-b3ef-44837f032caa" name="travelontrip-schedule-cache" />
			</when>
			<otherwise>
				<scatter-gather doc:name="Scatter-Gather" doc:id="58a64f2d-e1fa-4160-afad-075b0fa888b9" >
					<route >
						<set-variable value='#["travelOnTrip"]' doc:name="Set Variable" doc:id="efda4288-d573-4c98-a4e7-4dd437689ffa" variableName="companyname"/>
						<flow-ref doc:name="calling-fastgo-schedule-cache" doc:id="832130f4-3e6f-4028-9fb6-9fb8ff785ec3" name="fastgo-schedule-cache"/>
					</route>
					<route >
						<set-variable value='#["travelOnTrip"]' doc:name="Set Variable" doc:id="064eceea-99aa-4378-be63-e6b0f3a541fd" variableName="companyname"/>
						<flow-ref doc:name="calling-travelontrip-schedule-cache" doc:id="1f4aadd4-2924-463d-b9e9-3361a7143fd8" name="travelontrip-schedule-cache"/>
					</route>
				</scatter-gather>
				<logger level="INFO" doc:name="Logger" doc:id="09b1ca4f-8f89-4567-94c2-5a0427565b58" />
				<set-payload value="#[%dw 2.0&#10;output application/json&#10;---&#10;(payload.'0'.payload default []) ++ (payload.'1'.payload default [])]" doc:name="set payload" doc:id="5bdaa82b-c459-41a2-b4f0-a88b0e109efc" />
			</otherwise>
		</choice>
	</sub-flow>
</mule>
